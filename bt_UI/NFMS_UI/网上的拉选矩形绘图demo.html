<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<script type="application/javascript" src="js/jquery-3.2.1.js"></script>
		<script type="application/javascript" src="js/bootstrap.js"></script>
		<link rel="stylesheet" href="css/demo.css" />
		<link rel="stylesheet" href="css/bootstrap.min.css" />

		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" href="css/style.css" media="all" />
		<script type="text/javascript" src="js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
		
		<!--bootstrap-treeview start-->
		<link rel="stylesheet" type="text/css" href="css/bootstrap-treeview.min.css">
		<script type="text/javascript" src="js/bootstrap-treeview.min.js"></script>
		<!--bootstrap-treeview end-->
		<script src="js/leaflet.js"></script>
	<body>
    <div id="map" style="height:500px;width:500px;"></div>
    <button id="rectangleSel" > 拉框选择 </button>
    <!--<script src="js/maptiles.js"></script>-->
    <script>
        var map;
        $(function(){
            map = L.map('map', {
                center: [40, 100],
                zoom: 4
            });
            // 影像
            L.tileLayer("http://t{s}.tianditu.cn/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles", {
                subdomains: ["0", "1", "2", "3", "4", "5", "6", "7"]
            }).addTo(map);
            // 地名标注
            L.tileLayer("http://t{s}.tianditu.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=cia&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles", {
                subdomains: ["0", "1", "2", "3", "4", "5", "6", "7"]
            }).addTo(map);
            // 边界
            L.tileLayer("http://t{s}.tianditu.cn/ibo_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=ibo&tileMatrixSet=w&TileMatrix={z}&TileRow={y}&TileCol={x}&style=default&format=tiles", {
                subdomains: ["0", "1", "2", "3", "4", "5", "6", "7"]
            }).addTo(map);
            $("#rectangleSel").unbind('click').bind('click',function(){
                map.on('mousedown', rectangleMeasure.mousedown).on('mouseup', rectangleMeasure.mouseup);
            });
            console.log(map);
        });
         var rectangleMeasure = {
            startPoint: null,
            endPoint: null,
            rectangle:null,
            tips:null,
            layer: L.layerGroup(),
            color: "#0D82D7",
            addRectangle:function(){
                rectangleMeasure.destory();
                var bounds = [];
                bounds.push(rectangleMeasure.startPoint);
                bounds.push(rectangleMeasure.endPoint);
                rectangleMeasure.rectangle = L.rectangle(bounds, {color: rectangleMeasure.color, weight: 1});
                rectangleMeasure.rectangle.addTo(rectangleMeasure.layer);        
                
                var northWestPoint = rectangleMeasure.rectangle.getBounds().getNorthWest(),
                    northEastPoint = rectangleMeasure.rectangle.getBounds().getNorthEast(),
                    southEastPoint = rectangleMeasure.rectangle.getBounds().getSouthEast();
                var width = northWestPoint.distanceTo(northEastPoint)/1000,
                    height = northEastPoint.distanceTo(southEastPoint)/1000;
                    console.log("宽", width);
                    console.log("高", height);
                var area = Number(width) * Number(height);
                rectangleMeasure.addTips(area.toFixed(3));
                rectangleMeasure.layer.addTo(map);
            },
            addTips:function(area){
                console.log('面积:'+area);
                rectangleMeasure.tips = L.circleMarker(rectangleMeasure.endPoint, {color: rectangleMeasure.color});
                rectangleMeasure.tips.setRadius(1);
//              rectangleMeasure.tips.bindLabel("面积：" + area + "(平方公里)", {noHide: true, direction: 'right', clickable: true, className: "leaflet-label-tffq"});            
                rectangleMeasure.tips.addTo(rectangleMeasure.layer);
            },
            close:function(){
                var lab = rectangleMeasure.tips.getLabel();
                var tt = document.createTextNode(rectangleMeasure.tips.getLabel()._content);
                lab._container.innerHTML = "";
                lab._container.appendChild(tt);
                var span = document.createElement("span");
                span.innerHTML = "【关闭】";
                span.style.color = "#00ff40";
                lab._container.appendChild(span);
                L.DomEvent.addListener(span,"click",function(){
                    rectangleMeasure.destory();
                });
            },
            mousedown: function(e){
                rectangleMeasure.rectangle = null;
                rectangleMeasure.tips = null;
                map.dragging.disable();
                rectangleMeasure.startPoint = e.latlng;
                map.on('mousemove',rectangleMeasure.mousemove)
            },
            mousemove:function(e){
                rectangleMeasure.endPoint = e.latlng;
                rectangleMeasure.addRectangle();
                map.off('mousedown ', rectangleMeasure.mousedown).on('mouseup', rectangleMeasure.mouseup);
            },
            mouseup: function(e){        
                rectangleMeasure.close();
                map.dragging.enable();
                map.off('mousemove',rectangleMeasure.mousemove).off('mouseup', rectangleMeasure.mouseup).off('mousedown', rectangleMeasure.mousedown);
            },
            destory:function(){
                if(rectangleMeasure.rectangle)
                    rectangleMeasure.layer.removeLayer(rectangleMeasure.rectangle);
                if(rectangleMeasure.tips)
                    rectangleMeasure.layer.removeLayer(rectangleMeasure.tips);
            }
         }
    </script>
  </body>
</html>
